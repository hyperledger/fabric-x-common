/*
Copyright IBM Corp. All Rights Reserved.

SPDX-License-Identifier: Apache-2.0
*/

syntax = "proto3";

option go_package = "github.com/hyperledger/fabric-x-common/api/committerpb";

package committerpb;

import "google/protobuf/empty.proto";

import "api/applicationpb/config.proto";

import "api/committerpb/status.proto";

service QueryService {
    rpc GetRows(Query) returns (Rows) {};
    rpc BeginView(ViewParameters) returns (View) {};
    rpc EndView(View) returns (google.protobuf.Empty) {};
    rpc GetNamespacePolicies(google.protobuf.Empty) returns (applicationpb.NamespacePolicies) {};
    rpc GetConfigTransaction(google.protobuf.Empty) returns (applicationpb.ConfigTransaction) {};
    rpc GetTransactionStatus(TxStatusQuery) returns (TxStatusResponse) {};
}

message View {
    string id = 1;
}

message Query {
    optional View view = 1;
    repeated QueryNamespace namespaces = 2;
}

message Rows {
    repeated RowsNamespace namespaces = 1;
}

message ViewParameters {
    IsoLevel iso_level = 1;          // View's isolation level. Defaults to serializable.
    bool non_deferrable = 2;         // Do not defer errors. Defaults deferrable.
    uint64 timeout_milliseconds = 3; // View's timeout. Zero => maximal value
}

message QueryNamespace {
    string ns_id = 1;
    repeated bytes keys = 2;
}

message RowsNamespace {
    string ns_id = 1;
    repeated Row rows = 2;
}

message Row {
    bytes key = 1;
    bytes value = 2;
    uint64 version = 3;
}

message TxStatusQuery {
    optional View view = 1;
    repeated string tx_ids = 2;  // List of transaction IDs.
}

message TxStatusResponse {
    repeated TxStatus statuses = 1;
}

enum IsoLevel {
    ISO_LEVEL_UNSPECIFIED = 0; // Unspecified level will default to serializable.
    SERIALIZABLE = 1;
    REPEATABLE_READ = 2;
    READ_COMMITTED = 3;
    READ_UNCOMMITTED = 4;
}
